# Making reusable composite actions documented at
# https://docs.github.com/en/actions/tutorials/create-actions/create-a-composite-action#creating-a-composite-action-within-the-same-repository
name: 'Load a zone from a file, query the published zone'
description: 'Load a zone from a file, query the published zone'
defaults:
  # see: https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax#defaultsrunshell
  run:
    shell: bash --noprofile --norc -eo pipefail -x {0}
runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Prepare the system test environment
      uses: ./.github/actions/prepare-systest-env
      with:
        artifact-name: ${{ format('cascade_{0}_{1}_{2}', github.sha, matrix.os, matrix.rust) }}
    - run: target/debug/cascade --version
    - name: Setup and start the cascade daemon
      uses: ./.github/actions/setup-and-start-cascade
    - name: Add a policy
      run: |
        # Based on actions/setup-and-start-cascade/, query the Cascade config
        # to find the policy directory, at least until we have a better way of
        # doing this.
        CASCADE_CONF="${GITHUB_WORKSPACE}/cascade-dir/config.toml"
        POLICY_DIR=$(grep -E '^policy-dir.*=' ${CASCADE_CONF} | cut -d '=' -f 2 | cut -d '"' -f 2)
        INTEGRATION_TEST_DIR="${PWD}/integration-tests/review-unsigned-zone"
        # Copy the new test policy into the Cascade policy directory.
        cp ${INTEGRATION_TEST_DIR}/policies/test.toml ${POLICY_DIR}/
        # Fix the path to the review hook specified in the new test policy.
        sed -i -e "s|<INTEGRATION_TEST_DIR>|${INTEGRATION_TEST_DIR}|" ${POLICY_DIR}/test.toml
        # Make sure our test hooks are executable.
        chmod +x ${INTEGRATION_TEST_DIR}/hooks/*
        # Tell Cascade to load our new test policy.
        target/debug/cascade policy reload
    - name: Make a zonefile
      run: |
        tee example.test.zone <<'EOF'
        $TTL 5 ; use a very short TTL for sped up keyset rolls
        example.test.   IN SOA ns1.example.test. mail.example.test. (
                           1          ; serial
                          60          ; refresh (60 seconds)
                          60          ; retry (60 seconds)
                        3600          ; expire (1 hour)
                           5          ; minimum (5 seconds)
                        )
        @           NS  example.test.
        @           NS  ns1.example.test.
        @           A   127.0.0.1
        ns1         A   127.0.0.1

        www         A   169.254.1.1
        mail        MX  10 example.test.
        text        TXT "Hello World!"
        EOF
    - name: Add a zone
      run: |
        target/debug/cascade zone add --policy test --source example.test.zone example.test
    - name: Check zone status
      run: |
        timeout=10 # seconds
        start=$(date +%s)
        until target/debug/cascade zone status example.test | grep -q "Published zone available"; do
          if (($(date +%s) > (start + timeout))); then
            echo "timeout: zone status did not report published zone available" >&2
            exit 1
          fi
          sleep 1
        done
    - name: Query zone
      run: |
        dig text.example.test TXT | grep "Hello World"
    - name: Print log files on any failure in this job
      uses: ./.github/actions/print-logfiles
      if: failure()
