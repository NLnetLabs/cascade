# Testing Cascade

## Unit tests

Unit tests can be run as usual for Rust projects using `cargo test`:

1. `cargo test`
1. `cargo test --no-default-features`
1. `cargo test --all-features`


## Integration/System testing with `act`

The GitHub Action workflow in `.github/workflows/system-tests.yml` is currently
only for use with https://github.com/nektos/act via the `act-wrapper` script at
the root of this repository, which creates a custom container with a freshly
built cascade.


### TL;DR

Run all tests with:

- Docker: `./act-wrapper --network default -W .github/workflows/system-tests.yml`
- Podman: `./act-wrapper --network podman -W .github/workflows/system-tests.yml`

Run a single test with:

- Docker: `./act-wrapper --network default -W .github/workflows/system-tests.yml --job your-test`
- Podman: `./act-wrapper --network podman -W .github/workflows/system-tests.yml --job your-test`

Create a new test with:

- `./integration-tests/scripts/add-test.sh your-test "Your test name"`


### Network requirement (why --network default)

In the test environment, Unbound needs to bind to localhost:53, which is not
possible with act's default network. This is because localhost:53 is already in
use by your system's stub resolver (probably systemd-resolved). Instead of
act's default network selection (which instructs Docker/Podman to use the
[host's](https://docs.docker.com/engine/network/drivers/host/) network), you
need to specify a different container network to use. Docker and Podman each
provide default networks (not to be confused with act's default network
selection, which is Docker/Podman's `host` network). Docker's default
network is called `default`, while Podman's default network is called `podman`.
Therefore, you need to use `act --network default` on Docker, and `act
--network podman` on Podman.


### Running single jobs/tests

You can run single jobs with act using the `--job` option. However, if the job
has the `needs` option set to depend on other jobs, those jobs will always be run
before.

### Limitations

#### No init or systemd

Act runs the workflow in a container without init or systemd. Therefore, when
running other daemons, you either need to make use of their appropriate
daemonization features, or handle background jobs yourself.

Maybe running act with `--container-options --init` would work to add a dumb
init process, but isn't verified, yet.

#### All nameservers on the same address

Currently, it is not possible to add additional listener addresses on the
loopback (or any) network device in the `act` container. Therefore, all
nameservers are listening on 127.0.0.1 on different ports:

- Unbound: 127.0.0.1:53
- Primary NSD: 127.0.0.1:1055
- Secondary NSD: 127.0.0.1:1054
- Bind (authoritative for `.test`): 127.0.0.1:1053

It might be possible to change this in future versions of this setup with the
`--container-options --cap-add=NET_ADMIN` option for act, but this needs to be
tried out.


### Managing act's verbosity

act prints a lot of information on the terminal. To reduce or manage the amount
of text printed you can:

- Use act's `--concurrent-jobs 1` option to limit the number of jobs run by act
  at once, which will avoid interlacing output of different jobs.
- Use the `--quiet` option to disable logging of output from steps, which
  reduces the amount of output generated by act. However, by using this option
  you might miss valuable output when a test fails and have to re-run the test.
- Write the output to a file with `act ... 2>&1 | tee /tmp/act.log` (optionally
  using `unbuffer` from the `expect` package; left as an excercise for the
  user)

### Miscellaneous notes

- By default, tests are run using a debug build for both Cascade and dnst.
  - This can be changed per test using the `set-build-profile` action:
    ```
    - uses: ./.github/actions/set-build-profile
      with:
        build-profile: release
    ```
- `cascade`, `cascaded`, and `dnst` are added to the `$PATH`.
- By default, cascade is configured to use the directory:
  `${GITHUB_WORKSPACE}/cascade-dir`
- The default paths for configuration files can be fetched using the
  `integration-tests/scripts/get-default-path.sh` script.
- The workflow action `.github/actions/setup-and-start-cascade` also generates
  a default policy with `cascade template policy`.

### Creating a test

The workflow file `.github/workflows/system-tests.yml` only contains "stub"
runners for the tests, with the tests themselves being written in actions in
`.github/actions/tests/`.

You can easily generate the scaffolding for a test with the script
`./integration-tests/scripts/add-test.sh <job-name> "<test name/description>" [<PR-number>]`.
