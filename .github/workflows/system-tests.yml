name: System/Integration tests
on:
  # Triggering on PRs and arbitrary branch pushes is not enabled because most
  # of the time this expensive test suite should not be run. Using this
  # trigger allows explicitly running this test suite on a selected branch.
  workflow_dispatch:

env:
  # CARGO_TERM_VERBOSE: true
  CARGO_TERM_VERBOSE: false
jobs:
  build:
    # First build the project for once for all systems to deduplicate work
    # in the later tests
    name: Build the project for use by the later tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        rust: [stable]
        # rust: [1.84.0, stable, beta, nightly]
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    # FIXME: broken in act?
    # - name: Install Rust
    #   uses: hecrj/setup-rust-action@v2
    #   with:
    #     rust-version: ${{ matrix.rust }}

    - run: cargo build ${{ matrix.args }}
    - name: Tar built binaries to preserve permissions
      run: tar -cf target.tar target
    - name: Upload built binaries
      continue-on-error: true
      uses: actions/upload-artifact@v4
      with:
        name: ${{ format('cascade_{0}_{1}_{2}', github.sha, matrix.os, matrix.rust) }}
        # A file, directory or wildcard pattern that describes what to upload. Required.
        path: target.tar
        # The desired behavior if no files are found using the provided path.
        # Available Options:
        #   warn: Output a warning but do not fail the action
        #   error: Fail the action with an error message
        #   ignore: Do not output any warnings or errors, the action does not fail
        # Optional. Default is 'warn'
        if-no-files-found: error
        # The level of compression for Zlib to be applied to the artifact archive.
        # The value can range from 0 to 9.
        # For large files that are not easily compressed, a value of 0 is recommended for significantly faster uploads.
        # Optional. Default is '6'
        compression-level: 0

  test:
    name: Run tests with resolvers/namerservers
    runs-on: ${{ matrix.os }}
    # needs: build

    # # is missing node
    # container:
    #   image: ubuntu:latest
    #   options: --cap-add=NET_ADMIN
    strategy:
      matrix:
        os: [ubuntu-latest]
        rust: [stable]
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup and start the test environment with NSD, Unbound, and BIND9
      run: scripts/manage-test-environment.sh setup-and-start
    - name: Test the setup
      run: scripts/manage-test-environment.sh test
    # FIXME: broken in act?
    # - name: Install Rust
    #   uses: hecrj/setup-rust-action@v2
    #   with:
    #     rust-version: ${{ matrix.rust }}
    - uses: actions/download-artifact@v5
      id: download_binaries
      # Don't mark this run as failed if downloading the cached version fails,
      # we are building from source below if that happens. Inspired by:
      # https://github.com/actions/runner/issues/2679#issuecomment-1645222952
      continue-on-error: true
      with:
        name: ${{ format('cascade_{0}_{1}_{2}', github.sha, matrix.os, matrix.rust) }}
    - name: Extract downloaded binaries
      # due to 'continue-on-error: true' above the conclusion/status will
      # always be success, but we can check for success using the outcome key
      if: ${{ steps.download_binaries.outcome == 'success' }}
      run: tar -xf target.tar
    - name: Build from source if downloading artifacts failed
      # due to 'continue-on-error: true' above the conclusion/status will
      # always be success, but we can check for failure using the outcome key
      if: ${{ steps.download_binaries.outcome == 'failure' }}
      run: cargo build ${{ matrix.args }}

    - run: target/debug/cascade --version
    # # Optional, the container gets cleaned up anyway (at least in act)
    # - name: Stop the setup
    #   run: scripts/manage-test-environment.sh stop

  # debug-system:
  #   name: Debug the runner system
  #   runs-on: ${{ matrix.os }}
  #   strategy:
  #     matrix:
  #       os: [ubuntu-latest]
  #       rust: [stable]
  #   steps:
  #   - name: Test the setup
  #     run: bash -c "ip -br a && ps -ef && ss -tuln && dig test SOA && sudo nc -l -p 53 & sleep 1 && sudo pkill nc; cat /etc/resolv.conf"

